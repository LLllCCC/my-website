<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Yopo - ç§˜å¯†å‘å¸ƒåå°</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <style>
        .admin-box { max-width: 800px; margin: 50px auto; padding: 20px; background: var(--card-bg); border-radius: 15px; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid var(--card-border); background: var(--bg-color); color: var(--text-primary); }
        button { background: #007aff; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; }
    </style>
</head>
<body>
    <div class="admin-box">
        <h2>ğŸš€ å‘å¸ƒæ–°æ–‡ç« </h2>
        <input type="text" id="title" placeholder="æ–‡ç« æ ‡é¢˜">
        <input type="text" id="tags" placeholder="æ ‡ç­¾ (ç”¨é€—å·éš”å¼€)">
        <input type="text" id="cover" placeholder="å°é¢å›¾é“¾æ¥ (assets/...)">
        <textarea id="markdown-editor"></textarea>
        <input type="password" id="admin-token" placeholder="è¾“å…¥å‘å¸ƒå£ä»¤">
        <button onclick="publishPost()">ç«‹å³å‘å¸ƒåˆ°æœåŠ¡å™¨</button>
    </div>

    <hr style="margin: 40px 0; border: 0; border-top: 1px solid #333;">

    <div style="max-width: 800px; margin: 0 auto; padding-bottom: 50px;">
        <h2 style="color: #fff; margin-bottom: 20px;">ğŸ“‚ æ–‡ç« ç®¡ç†</h2>
        <div id="admin-post-list">
            <p style="color: #666;">æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨...</p>
        </div>
    </div>
    
<script>
    // ä½ çš„ API åœ°å€ (ç¡®ä¿æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼)
    const API_URL = 'https://yopoo.888431.xyz/api/posts'; 
    let currentEditingId = null;

    // 1. [æ ¸å¿ƒ] åŠ è½½æ–‡ç« åˆ—è¡¨
    async function loadPosts() {
        const listContainer = document.getElementById('admin-post-list');
        // å…ˆæ˜¾ç¤ºåŠ è½½ä¸­...
        listContainer.innerHTML = '<p style="color: #888;">æ­£åœ¨ä»æœåŠ¡å™¨è·å–æ–‡ç« ...</p>';
        
        try {
            console.log("å¼€å§‹åŠ è½½æ–‡ç« åˆ—è¡¨...");
            const res = await fetch(API_URL);
            
            if (!res.ok) throw new Error(`HTTPé”™è¯¯: ${res.status}`);
            
            const posts = await res.json();
            console.log("åŠ è½½æˆåŠŸï¼Œè·å–åˆ°æ–‡ç« æ•°:", posts.length);

            if (posts.length === 0) {
                listContainer.innerHTML = '<p style="color: #666;">æš‚æ— æ–‡ç« ï¼Œå¿«å»å‘å¸ƒä¸€ç¯‡å§ï¼</p>';
                return;
            }

            // æ¸²æŸ“åˆ—è¡¨
            listContainer.innerHTML = posts.map(post => `
                <div style="background: #1a1a1a; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;">
                    <div style="flex: 1; overflow: hidden;">
                        <div style="color: #fff; font-weight: bold; font-size: 16px;">${post.title}</div>
                        <div style="color: #666; font-size: 12px; margin-top: 4px;">ğŸ“… ${post.date.substring(0, 10)} | ğŸ·ï¸ ${post.tags || 'æ— æ ‡ç­¾'}</div>
                    </div>
                    <div style="min-width: 140px; text-align: right; margin-left: 10px;">
                        <button onclick="editPost(${post.id})" style="background: #2196F3; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">âœ ä¿®æ”¹</button>
                        <button onclick="deletePost(${post.id})" style="background: #F44336; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
            
        } catch (err) {
            console.error("åŠ è½½åˆ—è¡¨å¤±è´¥è¯¦æƒ…:", err);
            listContainer.innerHTML = `<p style="color: #ff4444;">åŠ è½½å¤±è´¥: ${err.message}<br>è¯·æŒ‰ F12 æŸ¥çœ‹æ§åˆ¶å° Console</p>`;
        }
    }

    // 2. [æ ¸å¿ƒ] å‘å¸ƒæˆ–ä¿å­˜æ–‡ç« 
    document.querySelector('button').onclick = async function() {
        // å®‰å…¨è·å–è¾“å…¥æ¡†å†…å®¹
        const getVal = (ph) => {
            const el = document.querySelector(`input[placeholder="${ph}"]`);
            return el ? el.value : '';
        };
        const getText = () => {
            const el = document.querySelector('textarea');
            return el ? el.value : '';
        };

        const title = getVal('æ–‡ç« æ ‡é¢˜');
        const tags = getVal('æ ‡ç­¾ (ç”¨é€—å·éš”å¼€)');
        const cover = getVal('å°é¢å›¾é“¾æ¥ (assets/...)');
        const token = getVal('è¾“å…¥å‘å¸ƒå£ä»¤'); // ç¡®ä¿è¿™é‡Œ placeholder æ–‡å­—å®Œå…¨åŒ¹é…
        const content = getText();

        if (!title) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼');
        if (!token) return alert('è¯·è¾“å…¥å£ä»¤ï¼');

        const data = { title, tags, cover, content, token };
        
        let url = API_URL;
        let method = 'POST';
        
        if (currentEditingId) {
            url = `${API_URL}/${currentEditingId}`;
            method = 'PUT';
        }

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const text = await res.text(); // å…ˆå–æ–‡å­—ï¼Œé˜²æ­¢ JSON è§£ææŒ‚æ‰
            
            if (res.ok) {
                alert(currentEditingId ? 'âœ… ä¿®æ”¹æˆåŠŸï¼' : 'ğŸ‰ å‘å¸ƒæˆåŠŸï¼');
                
                // æˆåŠŸåå…ˆåˆ·æ–°åˆ—è¡¨ï¼Œå†é‡ç½®è¡¨å•ï¼Œé˜²æ­¢é¡ºåºé”™è¯¯
                await loadPosts(); 
                safeResetForm(); 
            } else {
                alert('âŒ æ“ä½œå¤±è´¥: ' + text);
            }
        } catch (err) {
            console.error(err);
            alert('âŒ ç½‘ç»œé”™è¯¯æˆ–ä»£ç æŠ¥é”™: ' + err.message);
        }
    };

    // 3. å®‰å…¨é‡ç½®è¡¨å• (ä¿®å¤äº†ä¹‹å‰çš„ Bug)
    function safeResetForm() {
        currentEditingId = null;
        
        // å°è¯•æ‰¾æŒ‰é’®æ”¹å›æ–‡å­—
        const btn = document.querySelector('button');
        if(btn) btn.innerText = 'ç«‹å³å‘å¸ƒåˆ°æœåŠ¡å™¨';
        
        // æ¸…ç©ºè¾“å…¥æ¡† (ä½¿ç”¨é€šç”¨æ¸…ç©ºé€»è¾‘ï¼Œé˜²æ­¢æŠ¥é”™)
        document.querySelectorAll('input:not([type="button"])').forEach(input => input.value = '');
        document.querySelectorAll('textarea').forEach(area => area.value = '');
        
        // æ»šåŠ¨å›é¡¶éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 4. ä¿®æ”¹æ–‡ç« 
    window.editPost = async function(id) {
        const token = document.querySelector('input[placeholder="è¾“å…¥å‘å¸ƒå£ä»¤"]').value;
        if (!token) return alert('âš ï¸ è¯·å…ˆåœ¨åº•éƒ¨è¾“å…¥å£ä»¤ï¼Œå†ç‚¹å‡»ä¿®æ”¹ï¼');

        try {
            const res = await fetch(`${API_URL}/${id}`);
            const post = await res.json();
            
            // å›å¡«æ•°æ®
            const setVal = (ph, val) => {
                const el = document.querySelector(`input[placeholder="${ph}"]`);
                if(el) el.value = val;
            };
            
            setVal('æ–‡ç« æ ‡é¢˜', post.title);
            setVal('æ ‡ç­¾ (ç”¨é€—å·éš”å¼€)', post.tags);
            setVal('å°é¢å›¾é“¾æ¥ (assets/...)', post.cover);
            
            const area = document.querySelector('textarea');
            if(area) area.value = post.content;
            
            currentEditingId = id;
            const btn = document.querySelector('button');
            if(btn) btn.innerText = `ğŸ’¾ ä¿å­˜ä¿®æ”¹ (ID: ${post.id})`;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
        } catch(err) {
            alert('æ— æ³•è·å–æ–‡ç« è¯¦æƒ…: ' + err.message);
        }
    }

    // 5. åˆ é™¤æ–‡ç« 
    window.deletePost = async function(id) {
        const token = document.querySelector('input[placeholder="è¾“å…¥å‘å¸ƒå£ä»¤"]').value;
        if (!token) return alert('âš ï¸ è¯·å…ˆåœ¨åº•éƒ¨è¾“å…¥å£ä»¤ï¼Œå†ç‚¹å‡»åˆ é™¤ï¼');

        if (!confirm('ğŸ—‘ï¸ ç¡®å®šè¦å½»åº•åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ')) return;

        try {
            const res = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token })
            });
            
            if (res.ok) {
                alert('å·²åˆ é™¤ï¼');
                loadPosts(); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + await res.text());
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯');
        }
    }

    // é¡µé¢åŠ è½½å®Œæ¯•åï¼Œç«‹å³è·å–åˆ—è¡¨
    loadPosts();
</script>


</body>
</html>