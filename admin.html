<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Yopo - ç§˜å¯†å‘å¸ƒåå°</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <style>
        .admin-box { max-width: 800px; margin: 50px auto; padding: 20px; background: var(--card-bg); border-radius: 15px; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid var(--card-border); background: var(--bg-color); color: var(--text-primary); }
        button { background: #007aff; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; }
    </style>
</head>
<body>
    <div class="admin-box">
        <h2>ğŸš€ å‘å¸ƒæ–°æ–‡ç« </h2>
        <input type="text" id="title" placeholder="æ–‡ç« æ ‡é¢˜">
        <input type="text" id="tags" placeholder="æ ‡ç­¾ (ç”¨é€—å·éš”å¼€)">
        <input type="text" id="cover" placeholder="å°é¢å›¾é“¾æ¥ (assets/...)">
        <textarea id="markdown-editor"></textarea>
        <input type="password" id="admin-token" placeholder="è¾“å…¥å‘å¸ƒå£ä»¤">
        <button onclick="publishPost()">ç«‹å³å‘å¸ƒåˆ°æœåŠ¡å™¨</button>
    </div>

<script>
    const API_URL = 'https://yopoo.888431.xyz/api/posts'; // ä½ çš„APIåœ°å€
    let currentEditingId = null; // ç”¨äºè®°å½•å½“å‰æ­£åœ¨ä¿®æ”¹å“ªç¯‡æ–‡ç« 

    // 1. é¡µé¢åŠ è½½æ—¶ï¼Œè·å–æ‰€æœ‰æ–‡ç« åˆ—è¡¨
    async function loadPosts() {
        const listContainer = document.getElementById('admin-post-list');
        try {
            const res = await fetch(API_URL);
            const posts = await res.json();

            if (posts.length === 0) {
                listContainer.innerHTML = '<p style="color: #666;">æš‚æ— æ–‡ç« </p>';
                return;
            }

            // ç”Ÿæˆåˆ—è¡¨ HTML
            listContainer.innerHTML = posts.map(post => `
                <div style="background: #1a1a1a; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;">
                    <div style="flex: 1;">
                        <span style="color: #fff; font-weight: bold;">${post.title}</span>
                        <span style="color: #666; font-size: 12px; margin-left: 10px;">${post.date}</span>
                    </div>
                    <div style="min-width: 120px; text-align: right;">
                        <button onclick="editPost(${post.id})" style="background: #2196F3; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">âœ ä¿®æ”¹</button>
                        <button onclick="deletePost(${post.id})" style="background: #F44336; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        } catch (err) {
            console.error(err);
            listContainer.innerHTML = '<p style="color: red;">åŠ è½½åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥API</p>';
        }
    }

    // 2. ç‚¹å‡»â€œå‘å¸ƒ/ä¿å­˜â€æŒ‰é’®
    document.querySelector('button').onclick = async function() {
        const title = document.querySelector('input[placeholder="æ–‡ç« æ ‡é¢˜"]').value;
        const tags = document.querySelector('input[placeholder="æ ‡ç­¾ (ç”¨é€—å·éš”å¼€)"]').value;
        const cover = document.querySelector('input[placeholder="å°é¢å›¾é“¾æ¥ (assets/...)"]').value;
        const content = document.querySelector('textarea').value;
        const token = document.querySelector('input[placeholder="è¾“å…¥å‘å¸ƒå£ä»¤"]').value;

        if (!token) return alert('è¯·è¾“å…¥å£ä»¤ï¼');

        const data = { title, tags, cover, content, token };
        
        // åˆ¤æ–­æ˜¯â€œæ–°å»ºâ€è¿˜æ˜¯â€œä¿®æ”¹â€
        let url = API_URL;
        let method = 'POST';
        
        if (currentEditingId) {
            url = `${API_URL}/${currentEditingId}`;
            method = 'PUT'; // ä¿®æ”¹æ¨¡å¼
        }

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const text = await res.text();
            if (res.ok) {
                alert(currentEditingId ? 'ä¿®æ”¹æˆåŠŸï¼' : 'å‘å¸ƒæˆåŠŸï¼');
                resetForm(); // æ¸…ç©ºè¡¨å•
                loadPosts(); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert('å¤±è´¥: ' + text);
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯');
        }
    };

    // 3. ç‚¹å‡»â€œä¿®æ”¹â€æŒ‰é’® (å›å¡«æ•°æ®)
    window.editPost = async function(id) {
        const token = document.querySelector('input[placeholder="è¾“å…¥å‘å¸ƒå£ä»¤"]').value;
        if (!token) return alert('è¯·å…ˆåœ¨ä¸‹æ–¹è¾“å…¥å£ä»¤ï¼Œå†ç‚¹å‡»ä¿®æ”¹ï¼');

        // å…ˆè·å–æ–‡ç« è¯¦æƒ…
        try {
            const res = await fetch(`${API_URL}/${id}`);
            const post = await res.json();
            
            // å¡«å……åˆ°è¡¨å•é‡Œ
            document.querySelector('input[placeholder="æ–‡ç« æ ‡é¢˜"]').value = post.title;
            document.querySelector('input[placeholder="æ ‡ç­¾ (ç”¨é€—å·éš”å¼€)"]').value = post.tags || '';
            document.querySelector('input[placeholder="å°é¢å›¾é“¾æ¥ (assets/...)"]').value = post.cover || '';
            document.querySelector('textarea').value = post.content;
            
            // åˆ‡æ¢çŠ¶æ€
            currentEditingId = id;
            document.querySelector('button').innerText = `ğŸ’¾ ä¿å­˜ä¿®æ”¹ (ID: ${id})`;
            document.querySelector('h1').innerText = 'âœï¸ ä¿®æ”¹æ–‡ç« ';
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch(err) {
            alert('è·å–æ–‡ç« è¯¦æƒ…å¤±è´¥');
        }
    }

    // 4. ç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’®
    window.deletePost = async function(id) {
        const token = document.querySelector('input[placeholder="è¾“å…¥å‘å¸ƒå£ä»¤"]').value;
        if (!token) return alert('è¯·å…ˆåœ¨ä¸‹æ–¹è¾“å…¥å£ä»¤ï¼Œå†ç‚¹å‡»åˆ é™¤ï¼');

        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) return;

        try {
            const res = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token }) // æŠŠå£ä»¤ä¼ è¿‡å»
            });
            
            if (res.ok) {
                alert('å·²åˆ é™¤');
                loadPosts(); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + await res.text());
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯');
        }
    }

    function resetForm() {
        currentEditingId = null;
        document.querySelector('button').innerText = 'ç«‹å³å‘å¸ƒåˆ°æœåŠ¡å™¨';
        document.querySelector('h1').innerText = 'ğŸš€ å‘å¸ƒæ–°æ–‡ç« ';
        document.querySelector('input[placeholder="æ–‡ç« æ ‡é¢˜"]').value = '';
        document.querySelector('textarea').value = '';
        // ä¸æ¸…ç©ºå£ä»¤ï¼Œæ–¹ä¾¿è¿ç»­æ“ä½œ
    }

    // å¯åŠ¨æ—¶åŠ è½½åˆ—è¡¨
    loadPosts();
</script>

    <hr style="margin: 40px 0; border: 0; border-top: 1px solid #333;">

    <div style="max-width: 800px; margin: 0 auto; padding-bottom: 50px;">
        <h2 style="color: #fff; margin-bottom: 20px;">ğŸ“‚ æ–‡ç« ç®¡ç†</h2>
        <div id="admin-post-list">
            <p style="color: #666;">æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨...</p>
        </div>
    </div>

</body>
</html>